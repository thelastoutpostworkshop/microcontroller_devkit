class l extends Error{constructor(t,e){super(t),this.code=e,this.name="FatFSError"}}async function A(r={}){console.info("[fatfs-wasm] createFatFS() starting",r);const t=r.wasmURL??new URL(""+new URL("fatfs-DDsw86P7.wasm",import.meta.url).href,import.meta.url),e=await p(t),s=r.blockSize??512,n=r.blockCount??1024,i=e.fatfsjs_init(s,n);if(console.info("[fatfs-wasm] fatfsjs_init returned",i),i<0)throw new l("Failed to initialize FatFS",i);if(r.formatOnInit){const a=e.fatfsjs_format();if(console.info("[fatfs-wasm] fatfsjs_format returned",a),a<0)throw new l("Failed to format FatFS volume",a)}const o=new y(e);return console.info("[fatfs-wasm] Filesystem initialized"),o}async function E(r,t={}){console.info("[fatfs-wasm] createFatFSFromImage() starting");const e=t.wasmURL??new URL(""+new URL("fatfs-DDsw86P7.wasm",import.meta.url).href,import.meta.url),s=await p(e),n=b(r),i=t.blockSize??512;if(i===0)throw new Error("blockSize must be a positive integer");const o=n.length/i,a=t.blockCount??o;if(a*i!==n.length)throw new Error("Image size must equal blockSize * blockCount");const c=new Uint8Array(s.memory.buffer),f=s.malloc(n.length||1);if(!f)throw new l("Failed to allocate WebAssembly memory",-17);try{c.set(n,f);const m=s.fatfsjs_init_from_image(i,a,f,n.length);if(m<0)throw new l("Failed to initialize FatFS from image",m)}finally{s.free(f)}const h=new y(s);return console.info("[fatfs-wasm] Filesystem initialized from image"),h}class y{constructor(t){this.encoder=new TextEncoder,this.decoder=new TextDecoder,this.listBufferSize=4096,this.exports=t,this.heapU8=new Uint8Array(this.exports.memory.buffer)}format(){const t=this.exports.fatfsjs_format();this.assertOk(t,"format filesystem")}list(){let t=this.listBufferSize;for(;;){const e=this.alloc(t);try{const s=this.exports.fatfsjs_list(e,t);if(s===-17){this.listBufferSize=t*2,t=this.listBufferSize;continue}if(this.assertOk(s,"list files"),s===0)return[];const n=this.decoder.decode(this.heapU8.subarray(e,e+s));return _(n)}finally{this.exports.free(e)}}}readFile(t){const e=u(t),s=this.allocString(e);try{const n=this.exports.fatfsjs_file_size(s);if(this.assertOk(n,`stat file "${e}"`),n===0)return new Uint8Array;const i=this.alloc(n);try{const o=this.exports.fatfsjs_read_file(s,i,n);return this.assertOk(o,`read file "${e}"`),this.heapU8.slice(i,i+n)}finally{this.exports.free(i)}}finally{this.exports.free(s)}}writeFile(t,e){const s=u(t),n=U(e,this.encoder),i=this.allocString(s),o=this.alloc(n.length);try{n.length>0&&o&&this.heapU8.set(n,o);const a=this.exports.fatfsjs_write_file(i,n.length>0?o:0,n.length);this.assertOk(a,`write file "${s}"`)}finally{o&&this.exports.free(o),this.exports.free(i)}}deleteFile(t){const e=u(t),s=this.allocString(e);try{const n=this.exports.fatfsjs_delete_file(s);this.assertOk(n,`delete file "${e}"`)}finally{this.exports.free(s)}}toImage(){const t=this.exports.fatfsjs_storage_size();if(t===0)return new Uint8Array;const e=this.alloc(t);try{const s=this.exports.fatfsjs_export_image(e,t);return this.assertOk(s,"export filesystem image"),this.heapU8.slice(e,e+t)}finally{this.exports.free(e)}}refreshHeap(){this.heapU8.buffer!==this.exports.memory.buffer&&(this.heapU8=new Uint8Array(this.exports.memory.buffer))}alloc(t){if(t<=0)return 0;const e=this.exports.malloc(t);if(!e)throw new l("Failed to allocate WebAssembly memory",-17);return this.refreshHeap(),e}allocString(t){const e=this.encoder.encode(t),s=this.alloc(e.length+1);return this.heapU8.set(e,s),this.heapU8[s+e.length]=0,s}assertOk(t,e){if(t<0)throw new l(`Unable to ${e}`,t)}}async function p(r){const t=g(r);console.info("[fatfs-wasm] Fetching wasm from",t.href);const e={memory:null},s=S(e);let n=await fetch(t);if(!n.ok)throw new Error(`Unable to fetch FatFS wasm from ${n.url}`);if(console.info("[fatfs-wasm] Fetch complete, status",n.status),"instantiateStreaming"in WebAssembly&&typeof WebAssembly.instantiateStreaming=="function")try{console.info("[fatfs-wasm] Attempting instantiateStreaming");const a=await WebAssembly.instantiateStreaming(n,s);return e.memory=w(a.instance.exports),console.info("[fatfs-wasm] instantiateStreaming succeeded"),a.instance.exports}catch(a){if(console.warn("Unable to instantiate FatFS wasm via streaming, retrying with arrayBuffer()",a),n=await fetch(t),!n.ok)throw new Error(`Unable to fetch FatFS wasm from ${n.url}`);console.info("[fatfs-wasm] Fallback fetch complete, status",n.status)}console.info("[fatfs-wasm] Instantiating from ArrayBuffer fallback");const i=await n.arrayBuffer(),o=await WebAssembly.instantiate(i,s);return e.memory=w(o.instance.exports),console.info("[fatfs-wasm] instantiate(bytes) succeeded"),o.instance.exports}function _(r){return r?r.split(`
`).filter(t=>t.length>0).map(t=>{const[e,s]=t.split("	");return{path:e??"",size:Number(s??"0")||0}}):[]}function u(r){const e=r.trim().replace(/\\/g,"/").replace(/^\/+/,"");if(!e)throw new Error('Path must point to a file (e.g. "docs/readme.txt")');const s=e.replace(/\/{2,}/g,"/");return s.endsWith("/")?s.slice(0,-1):s}function U(r,t){if(typeof r=="string")return t.encode(r);if(r instanceof Uint8Array)return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);throw new Error("Unsupported file payload type")}function b(r){if(r instanceof Uint8Array)return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);throw new Error("Expected Uint8Array or ArrayBuffer for filesystem image")}function g(r){if(r instanceof URL)return r;const e=(typeof globalThis<"u"&&"location"in globalThis?globalThis.location:void 0)?.href;try{return e?new URL(r,e):new URL(r)}catch(s){throw new Error(`Unable to resolve wasm URL from "${r}": ${String(s)}`)}}function S(r){const t=()=>{},e=()=>0;return{env:{emscripten_notify_memory_growth:t},wasi_snapshot_preview1:{fd_close:e,fd_seek:e,fd_write:(s,n,i,o)=>x(r,s,n,i,o)}}}function x(r,t,e,s,n){const i=r.memory;if(!i)return 0;const o=new DataView(i.buffer);let a=0;for(let c=0;c<s;c++){const f=e+c*8,h=o.getUint32(f,!0),m=o.getUint32(f+4,!0);if(a+=m,t===1||t===2){const d=new Uint8Array(i.buffer,h,m),F=new TextDecoder().decode(d);console.info(`[fatfs-wasm::fd_write fd=${t}] ${F}`)}}return o.setUint32(n,a,!0),0}function w(r){for(const t of Object.values(r))if(t instanceof WebAssembly.Memory)return t;return null}export{l as FatFSError,A as createFatFS,E as createFatFSFromImage};
